{% extends 'Agences/base.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-line me-2"></i>Tableau de Bord Commercial</h2>
    <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-plus me-2"></i>Nouvelle Action
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#appelOffreModal">
                <i class="fas fa-bullhorn me-2"></i>Lancer un appel d'offre
            </a></li>
        </ul>
    </div>
</div>

<!-- Alertes pour les appels d'offre en retard -->
<div id="alertes-container"></div>

<!-- S√©lecteur de Vue -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-view="gantt">
                        <i class="fas fa-project-diagram me-2"></i>Vue Gantt
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-view="kanban">
                        <i class="fas fa-columns me-2"></i>Vue Kanban
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-view="timeline">
                        <i class="fas fa-stream me-2"></i>Timeline
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-view="calendar">
                        <i class="fas fa-calendar-alt me-2"></i>Calendrier
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtres -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>Filtres
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Filtre √âtat -->
                    <div class="col-md-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">√âtat</label>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllCheckboxes('etat', true)">Tout</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllCheckboxes('etat', false)">Aucun</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="invertCheckboxes('etat')">Inverser</button>
                            </div>
                        </div>
                        <div class="filter-group" id="filter-etat">
                            <div class="form-check">
                                <input class="form-check-input filter-checkbox" type="checkbox" value="En attente" id="filter-en-attente" checked>
                                <label class="form-check-label" for="filter-en-attente">
                                    En Attente
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-checkbox" type="checkbox" value="En cours" id="filter-en-cours" checked>
                                <label class="form-check-label" for="filter-en-cours">
                                    En Cours
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-checkbox" type="checkbox" value="Gagn√©" id="filter-gagne" checked>
                                <label class="form-check-label" for="filter-gagne">
                                    Gagn√©
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input filter-checkbox" type="checkbox" value="Perdu" id="filter-perdu" checked>
                                <label class="form-check-label" for="filter-perdu">
                                    Perdu
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Filtre Agence -->
                    <div class="col-md-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">Agence</label>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllCheckboxes('agence', true)">Tout</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllCheckboxes('agence', false)">Aucun</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="invertCheckboxes('agence')">Inverser</button>
                            </div>
                        </div>
                        <div class="filter-group" id="filter-agence">
                            {% for agence in agences %}
                            <div class="form-check">
                                <input class="form-check-input filter-checkbox" type="checkbox" value="{{ agence.nom }}" id="filter-agence-{{ agence.id }}" checked>
                                <label class="form-check-label" for="filter-agence-{{ agence.id }}">
                                    {{ agence.nom }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Filtre CA -->
                    <div class="col-md-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">Responsable CA</label>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllCheckboxes('ca', true)">Tout</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllCheckboxes('ca', false)">Aucun</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="invertCheckboxes('ca')">Inverser</button>
                            </div>
                        </div>
                        <div class="filter-group" id="filter-ca">
                            <!-- Charg√© dynamiquement -->
                        </div>
                    </div>

                    <!-- Filtre Prestations -->
                    <div class="col-md-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">Types de Prestation</label>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllCheckboxes('prestation', true)">Tout</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllCheckboxes('prestation', false)">Aucun</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="invertCheckboxes('prestation')">Inverser</button>
                            </div>
                        </div>
                        <div class="filter-group" id="filter-prestation">
                            {% for prestation in prestations %}
                            <div class="form-check">
                                <input class="form-check-input filter-checkbox" type="checkbox" value="{{ prestation.nom }}" id="filter-prestation-{{ prestation.id }}" checked>
                                <label class="form-check-label" for="filter-prestation-{{ prestation.id }}">
                                    {{ prestation.nom }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">Appels d'Offre</label>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllCheckboxes('ao', true)">Tout</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllCheckboxes('ao', false)">Aucun</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="invertCheckboxes('ao')">Inverser</button>
                            </div>
                        </div>
                        <div class="filter-group" id="filter-ao">
                            <!-- Charg√© dynamiquement -->
                        </div>
                    </div>
                </div>
                <div class="mt-3 d-flex justify-content-between">
                    <button class="btn btn-sm btn-outline-secondary" id="reset-filters">
                        <i class="fas fa-redo me-1"></i>R√©initialiser les filtres
                    </button>
                    <button class="btn btn-sm btn-primary" id="apply-filters">
                        <i class="fas fa-check me-1"></i>Appliquer les filtres
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vue Gantt -->
<div id="gantt-view" class="view-content">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-project-diagram me-2"></i>Diagramme de Gantt - Appels d'Offre
                    </h5>
                    <div class="gantt-controls">
                        <!-- Contr√¥les ajout√©s dynamiquement -->
                    </div>
                </div>
                <div class="card-body">
                    <div class="gantt-container">
                        <div class="gantt-header">
                            <div class="gantt-sidebar-header">Appels d'Offre</div>
                            <div class="gantt-timeline-header" id="gantt-timeline-header">
                                <!-- En-t√™te de timeline g√©n√©r√© dynamiquement -->
                            </div>
                        </div>
                        <div class="gantt-body">
                            <div class="gantt-sidebar">
                                <div class="gantt-task-list" id="gantt-task-list">
                                    <!-- Liste des t√¢ches g√©n√©r√©e dynamiquement -->
                                </div>
                            </div>
                            <div class="gantt-timeline">
                                <div class="gantt-grid" id="gantt-grid">
                                    <!-- Grille du Gantt g√©n√©r√©e dynamiquement -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vue Kanban -->
<div id="kanban-view" class="view-content d-none">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-columns me-2"></i>Tableau Kanban - Appels d'Offre
                    </h5>
                </div>
                <div class="card-body">
                    <div class="kanban-board" id="kanban-board">
                        <!-- Colonnes Kanban g√©n√©r√©es dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vue Timeline -->
<div id="timeline-view" class="view-content d-none">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-stream me-2"></i>Timeline - Appels d'Offre
                    </h5>
                    <div class="d-flex align-items-center">
                        <div class="timeline-info me-2">
                            <span class="badge bg-primary">
                                <i class="fas fa-clock me-1"></i>
                                <span id="timeline-current-time"></span>
                            </span>
                        </div>
                        <div class="timeline-controls">
                            <!-- Contr√¥les ajout√©s dynamiquement -->
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="timeline-container">
                        <div class="timeline-header" id="timeline-header">
                            <!-- En-t√™te de timeline g√©n√©r√© dynamiquement -->
                        </div>
                        <div class="timeline-events" id="timeline-events">
                            <!-- √âv√©nements de timeline g√©n√©r√©s dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vue Calendrier -->
<div id="calendar-view" class="view-content d-none">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Calendrier - Appels d'Offre
                    </h5>
                    <div class="calendar-controls">
                        <button class="btn btn-sm btn-outline-secondary" id="calendar-today">
                            Aujourd'hui
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary" id="calendar-prev">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="calendar-next">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <span class="calendar-current-month ms-2 fw-bold" id="calendar-current-month"></span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="calendar-weekdays">
                                <div class="calendar-weekday">Lun</div>
                                <div class="calendar-weekday">Mar</div>
                                <div class="calendar-weekday">Mer</div>
                                <div class="calendar-weekday">Jeu</div>
                                <div class="calendar-weekday">Ven</div>
                                <div class="calendar-weekday weekend">Sam</div>
                                <div class="calendar-weekday weekend">Dim</div>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Grille du calendrier g√©n√©r√©e dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour lancer un appel d'offre -->
<div class="modal fade" id="appelOffreModal" tabindex="-1" aria-labelledby="appelOffreModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="appelOffreModalLabel">
                    <i class="fas fa-bullhorn me-2"></i>Lancer un Nouvel Appel d'Offre
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="appelOffreForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="date_debut" class="form-label">Date de D√©but *</label>
                            <input type="date" class="form-control" id="date_debut" name="date_debut" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="date_fin" class="form-label">Date de Fin *</label>
                            <input type="date" class="form-control" id="date_fin" name="date_fin" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="agence" class="form-label">Agence *</label>
                            <select class="form-select" id="agence" name="agence" required>
                                <option value="">S√©lectionnez une agence</option>
                                {% for agence in agences %}
                                <option value="{{ agence.id }}">{{ agence.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Type de Prestation - Cases √† cocher avec recherche -->
                    <div class="mb-3">
                        <label class="form-label">Types de Prestation *</label>
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="prestation-search"
                                           placeholder="Rechercher une prestation...">
                                </div>
                                <div class="prestations-container" style="max-height: 200px; overflow-y: auto;">
                                    {% for prestation in prestations %}
                                    <div class="form-check mb-2 prestation-item">
                                        <input class="form-check-input" type="checkbox"
                                               name="prestations" value="{{ prestation.id }}"
                                               id="prestation-{{ prestation.id }}">
                                        <label class="form-check-label" for="prestation-{{ prestation.id }}">
                                            {{ prestation.nom }}
                                        </label>
                                    </div>
                                    {% empty %}
                                    <p class="text-muted">Aucune prestation disponible</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="form-text">S√©lectionnez une ou plusieurs prestations</div>
                    </div>

                    <!-- Responsable CA -->
                    <div class="mb-3">
                        <label for="responsable_ca" class="form-label">Responsable CA *</label>
                        <select class="form-select" id="responsable_ca" name="responsable_ca" required disabled>
                            <option value="">Chargement des responsables...</option>
                        </select>
                        <div class="form-text" id="responsable-help">
                            S√©lectionnez d'abord une agence et au moins une prestation
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description (optionnelle)</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="Description de l'appel d'offre..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        <i class="fas fa-rocket me-2"></i>Lancer l'Appel d'Offre
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour marquer comme gagn√© -->
<div class="modal fade" id="gagneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Marquer comme Gagn√©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>√ätes-vous s√ªr de vouloir marquer cet appel d'offre comme gagn√© ?</p>
                <div class="mb-3">
                    <label for="commentaire_gagne" class="form-label">Commentaire (optionnel)</label>
                    <textarea class="form-control" id="commentaire_gagne" rows="3"
                              placeholder="Commentaire sur la r√©ussite..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="confirm-gagne">
                    <i class="fas fa-trophy me-2"></i>Marquer comme Gagn√©
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour marquer comme perdu -->
<div class="modal fade" id="perduModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Marquer comme Perdu</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>√ätes-vous s√ªr de vouloir marquer cet appel d'offre comme perdu ?</p>
                <div class="mb-3">
                    <label for="commentaire_perdu" class="form-label">Commentaire (optionnel)</label>
                    <textarea class="form-control" id="commentaire_perdu" rows="3"
                              placeholder="Commentaire sur l'√©chec..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirm-perdu">
                    <i class="fas fa-times me-2"></i>Marquer comme Perdu
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.view-content {
    min-height: 600px;
}

/* Styles Gantt */
.gantt-container {
    display: flex;
    flex-direction: column;
    height: 500px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.gantt-header {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.gantt-sidebar-header {
    display: none;
}

.gantt-timeline-header {
    flex: 1;
    display: flex;
    overflow-x: hidden;
    min-width: 0;
}

.gantt-timeline-header .gantt-period {
    padding: 10px 2px;
    text-align: center;
    min-width: 80px;
    border-right: 1px solid #dee2e6;
    font-weight: bold;
    flex-shrink: 0;
    font-size: 0.8em;
    line-height: 1.2;
}

.gantt-body {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.gantt-sidebar {
    display: none;
}

.gantt-timeline {
    flex: 1;
    overflow: auto;
    position: relative;
}

.gantt-grid {
    position: relative;
    height: 100%;
    min-width: 2000px;
}

.gantt-bar {
    position: absolute;
    height: 30px;
    border-radius: 4px;
    margin-top: 5px;
    cursor: pointer;
    transition: all 0.2s;
    opacity: 0.8;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
}

.gantt-bar:hover {
    transform: translateY(-1px);
    opacity: 1;
}

.gantt-bar.gagne {
    background: #28a745 !important;
}

.gantt-bar.perdu {
    background: #dc3545 !important;
}

.gantt-bar.gagne::after {
    content: "üèÜ";
    position: absolute;
    right: 5px;
    font-size: 14px;
    opacity: 0.9;
}

.gantt-bar.perdu::after {
    content: "‚ùå";
    position: absolute;
    right: 5px;
    font-size: 14px;
    opacity: 0.9;
}

/* Styles Kanban */
.kanban-board {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    padding: 20px 0;
    min-height: 500px;
}

.kanban-column {
    min-width: 300px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
}

.kanban-column-header {
    font-weight: bold;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #dee2e6;
}

.kanban-card {
    background: white;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.2s;
    border-left: 4px solid #6c757d;
    position: relative;
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.kanban-card.gagne {
    border-left-color: #28a745 !important;
    background: linear-gradient(135deg, #ffffff 0%, #f8fff8 100%);
}

.kanban-card.perdu {
    border-left-color: #dc3545 !important;
    background: linear-gradient(135deg, #ffffff 0%, #fff8f8 100%);
}

.kanban-card.gagne::after {
    content: "üèÜ";
    position: absolute;
    top: 50%;
    right: 15px;
    transform: translateY(-50%);
    font-size: 20px;
    opacity: 0.3;
}

.kanban-card.perdu::after {
    content: "‚ùå";
    position: absolute;
    top: 50%;
    right: 15px;
    transform: translateY(-50%);
    font-size: 20px;
    opacity: 0.3;
}

/* Styles Timeline */
.timeline-container {
    position: relative;
    height: 400px;
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #dee2e6;
}

.timeline-header {
    display: flex;
    background: #e9ecef;
    border-bottom: 1px solid #dee2e6;
    overflow-x: hidden;
}

.timeline-period {
    padding: 10px 2px;
    text-align: center;
    min-width: 100px;
    border-right: 1px solid #dee2e6;
    font-weight: bold;
    flex-shrink: 0;
    font-size: 0.8em;
    line-height: 1.2;
}

.timeline-events {
    position: relative;
    height: calc(100% - 50px);
    overflow: auto;
}

.timeline-content {
    min-width: 100%;
    position: relative;
    height: 100%;
}

.timeline-event {
    position: absolute;
    background: white;
    padding: 10px 15px;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    min-width: 200px;
    cursor: pointer;
    transition: all 0.3s;
    border-left: 4px solid #6c757d;
    opacity: 0.8;
}

.timeline-event:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    opacity: 1;
}

.timeline-event.gagne {
    background: #28a745 !important;
    border-left-color: #28a745 !important;
    color: white;
}

.timeline-event.perdu {
    background: #dc3545 !important;
    border-left-color: #dc3545 !important;
    color: white;
}

.timeline-event.gagne::after {
    content: "üèÜ";
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 14px;
}

.timeline-event.perdu::after {
    content: "‚ùå";
    position: absolute;
    top: 5px;
    right: 5px;
    font-size: 14px;
}

/* Styles Calendrier */
.calendar-container {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.calendar-weekday {
    padding: 15px;
    text-align: center;
    font-weight: bold;
    border-right: 1px solid #dee2e6;
}

.calendar-weekday.weekend {
    background: #f8f9fa;
    color: #dc3545;
}

.calendar-weekday:last-child {
    border-right: none;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-auto-rows: 120px;
}

.calendar-day {
    border-right: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
    padding: 8px;
    position: relative;
    background: white;
}

.calendar-day:nth-child(7n) {
    border-right: none;
}

.calendar-day.other-month {
    background: #f8f9fa;
    color: #6c757d;
}

.calendar-day.today {
    background: #e3f2fd;
}

.calendar-day.weekend {
    background: repeating-linear-gradient(
        45deg,
        #f8f9fa,
        #f8f9fa 10px,
        #e9ecef 10px,
        #e9ecef 20px
    );
}

.calendar-day-number {
    font-weight: bold;
    margin-bottom: 5px;
}

.calendar-event {
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 0.75rem;
    margin-bottom: 2px;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    opacity: 0.9;
    position: relative;
}

.calendar-event.gagne {
    background: #28a745 !important;
}

.calendar-event.perdu {
    background: #dc3545 !important;
}

.calendar-event.gagne::after {
    content: "üèÜ";
    position: absolute;
    right: 3px;
    font-size: 10px;
}

.calendar-event.perdu::after {
    content: "‚ùå";
    position: absolute;
    right: 3px;
    font-size: 10px;
}

/* Styles Filtres */
.filter-group {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 10px;
}

.filter-group .form-check {
    margin-bottom: 5px;
}

.filter-controls {
    margin-bottom: 10px;
}

/* Barre du jour actuel */
.current-day-line {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: #dc3545;
    z-index: 10;
    pointer-events: none;
}

.current-day-line::after {
    content: "Aujourd'hui";
    position: absolute;
    top: -25px;
    left: -30px;
    background: #dc3545;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: bold;
    white-space: nowrap;
}

/* Contr√¥les Gantt am√©lior√©s */
.gantt-controls .btn-group {
    margin-left: 10px;
}

/* Alertes */
.alerte-retard {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
}

.alerte-retard h6 {
    color: #721c24;
    margin-bottom: 5px;
}

/* Responsive */
@media (max-width: 768px) {
    .gantt-sidebar {
        width: 200px;
    }

    .gantt-sidebar-header {
        width: 200px;
    }

    .kanban-column {
        min-width: 250px;
    }

    .filter-group {
        max-height: 120px;
    }
}
</style>

<script>
// Variables globales
let appelsOffre = [];
let currentView = 'gantt';
let currentCalendarDate = new Date();
let currentYear = new Date().getFullYear();
let currentTimelineYear = new Date().getFullYear();
let currentAppelId = null;
let filtersApplied = false;
let agencesCouleurs = {};

// Fonction pour sauvegarder la vue active
function saveCurrentView(view) {
    localStorage.setItem('currentView', view);
}

// Fonction pour r√©cup√©rer la vue active
function getCurrentView() {
    return localStorage.getItem('currentView') || 'gantt';
}

// Fonction pour obtenir le token CSRF
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Fonction pour obtenir la couleur d'un appel (statut prioritaire, sinon agence)
function getColorForAppel(appel) {
    const statutColor = getColorForStatut(appel.statut);
    if (statutColor) {
        return statutColor;
    }
    return agencesCouleurs[appel.agence] || '#007bff';
}

// Fonction pour charger les couleurs des agences depuis l'API
function loadAgencesCouleurs() {
    fetch('/agences/api/agences-couleurs/')
        .then(response => response.json())
        .then(data => {
            agencesCouleurs = data.couleurs;
            console.log('Couleurs des agences charg√©es:', agencesCouleurs);
            updateAllViews();
        })
        .catch(error => {
            console.error('Erreur lors du chargement des couleurs:', error);
            agencesCouleurs = {};
        });
}

// Chargement initial des donn√©es
document.addEventListener('DOMContentLoaded', function() {
    currentView = getCurrentView();

    initializePrestationsSearch();
    setupEventListeners();
    loadAppelsOffre();
    checkAppelsEnRetard();
    loadAgencesCouleurs();
    loadFilters();

    setTimeout(() => {
        switchView(currentView);
    }, 100);
});

function initializePrestationsSearch() {
    const searchInput = document.getElementById('prestation-search');
    const prestationItems = document.querySelectorAll('.prestation-item');

    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();

            prestationItems.forEach(item => {
                const label = item.querySelector('.form-check-label').textContent.toLowerCase();
                if (label.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
}

function setupEventListeners() {
    // Changement de vue
    document.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', function() {
            const view = this.getAttribute('data-view');
            switchView(view);
        });
    });

    // Contr√¥les calendrier
    const calendarToday = document.getElementById('calendar-today');
    const calendarPrev = document.getElementById('calendar-prev');
    const calendarNext = document.getElementById('calendar-next');
    if (calendarToday) calendarToday.addEventListener('click', showTodayCalendar);
    if (calendarPrev) calendarPrev.addEventListener('click', prevMonthCalendar);
    if (calendarNext) calendarNext.addEventListener('click', nextMonthCalendar);

    // Formulaire appel d'offre
    const agenceSelect = document.getElementById('agence');
    const appelOffreForm = document.getElementById('appelOffreForm');

    if (agenceSelect) {
        agenceSelect.addEventListener('change', loadResponsablesCA);
    }

    // √âcouter les changements des cases √† cocher prestations
    document.querySelectorAll('input[name="prestations"]').forEach(checkbox => {
        checkbox.addEventListener('change', loadResponsablesCA);
    });

    if (appelOffreForm) {
        appelOffreForm.addEventListener('submit', function(e) {
            e.preventDefault();
            launchAppelOffre();
        });
    }

    // Validation des dates
    const dateDebut = document.getElementById('date_debut');
    const dateFin = document.getElementById('date_fin');
    if (dateDebut) dateDebut.addEventListener('change', validateDates);
    if (dateFin) dateFin.addEventListener('change', validateDates);

    // Filtres
    document.getElementById('apply-filters').addEventListener('click', applyFilters);
    document.getElementById('reset-filters').addEventListener('click', resetFilters);

    // Modals
    document.getElementById('confirm-gagne').addEventListener('click', confirmerGagne);
    document.getElementById('confirm-perdu').addEventListener('click', confirmerPerdu);

    // Synchronisation du scroll
    synchronizeGanttScroll();
    synchronizeTimelineScroll();
}

// === CHARGEMENT DES DONN√âES ===

function loadAppelsOffre() {
    fetch('/agences/api/appels-offre/')
        .then(response => response.json())
        .then(data => {
            appelsOffre = data.appels_offre;
            updateAllViews();
            updateFilterCA();
            updateFilterAO();
        })
        .catch(error => {
            console.error('Erreur lors du chargement des appels d\'offre:', error);
            showError('Erreur lors du chargement des donn√©es');
        });
}

function checkAppelsEnRetard() {
    fetch('/agences/api/appels-offre/retard/')
        .then(response => response.json())
        .then(data => {
            if (data.appels_retard && data.appels_retard.length > 0) {
                showAlertesRetard(data.appels_retard);
            }
        })
        .catch(error => {
            console.error('Erreur lors de la v√©rification des retards:', error);
        });
}

// === GESTION DES VUES ===

function switchView(view) {
    currentView = view;
    saveCurrentView(view);

    // Mettre √† jour les boutons
    document.querySelectorAll('[data-view]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-view="${view}"]`).classList.add('active');

    // Afficher la vue s√©lectionn√©e
    document.querySelectorAll('.view-content').forEach(v => {
        v.classList.add('d-none');
    });
    document.getElementById(`${view}-view`).classList.remove('d-none');

    // Mettre √† jour la vue active
    updateCurrentView();
}

function updateCurrentView() {
    switch(currentView) {
        case 'gantt':
            addGanttControls();
            generateGanttView();
            synchronizeGanttScroll();
            break;
        case 'kanban':
            generateKanbanView();
            break;
        case 'timeline':
            addTimelineControls();
            generateTimelineView();
            synchronizeTimelineScroll();
            break;
        case 'calendar':
            generateCalendarView();
            break;
    }
}

function synchronizeGanttScroll() {
    const ganttTimeline = document.querySelector('.gantt-timeline');
    const ganttTimelineHeader = document.querySelector('.gantt-timeline-header');

    if (ganttTimeline && ganttTimelineHeader) {
        ganttTimeline.addEventListener('scroll', function() {
            ganttTimelineHeader.scrollLeft = this.scrollLeft;
            // Sauvegarder la position de scroll
            localStorage.setItem('ganttScrollLeft', this.scrollLeft);
        });
    }
}

function synchronizeTimelineScroll() {
    const timelineEvents = document.querySelector('.timeline-events');
    const timelineHeader = document.querySelector('.timeline-header');

    if (timelineEvents && timelineHeader) {
        timelineEvents.addEventListener('scroll', function() {
            timelineHeader.scrollLeft = this.scrollLeft;
            // Sauvegarder la position de scroll
            localStorage.setItem('timelineScrollLeft', this.scrollLeft);
        });

        timelineHeader.addEventListener('wheel', function(e) {
            timelineEvents.scrollLeft += e.deltaY;
            e.preventDefault();
        });
    }
}

// Navigation Gantt par ann√©e
function prevYearGantt() {
    currentYear--;
    document.getElementById('gantt-year-display').textContent = currentYear;
    generateGanttView();
}

function nextYearGantt() {
    currentYear++;
    document.getElementById('gantt-year-display').textContent = currentYear;
    generateGanttView();
}

// Navigation Timeline par ann√©e
function prevYearTimeline() {
    currentTimelineYear--;
    document.getElementById('timeline-year-display').textContent = currentTimelineYear;
    generateTimelineView();
}

function nextYearTimeline() {
    currentTimelineYear++;
    document.getElementById('timeline-year-display').textContent = currentTimelineYear;
    generateTimelineView();
}

// Ajouter contr√¥les Gantt
function addGanttControls() {
    const ganttControls = document.querySelector('#gantt-view .gantt-controls');
    if (ganttControls && !document.getElementById('gantt-year-display')) {
        ganttControls.innerHTML = `
            <div class="btn-group btn-group-sm me-2">
                <button class="btn btn-outline-secondary" onclick="prevYearGantt()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-outline-secondary disabled" id="gantt-year-display">${currentYear}</button>
                <button class="btn btn-outline-secondary" onclick="nextYearGantt()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;
    }
}

// Ajouter contr√¥les Timeline
function addTimelineControls() {
    const timelineControls = document.querySelector('#timeline-view .timeline-controls');
    if (timelineControls && !document.getElementById('timeline-year-display')) {
        timelineControls.innerHTML = `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="prevYearTimeline()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-outline-secondary disabled" id="timeline-year-display">${currentTimelineYear}</button>
                <button class="btn btn-outline-secondary" onclick="nextYearTimeline()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;
    }
}

// === GESTION DU FORMULAIRE ===

function getSelectedPrestations() {
    const selectedPrestations = [];
    document.querySelectorAll('input[name="prestations"]:checked').forEach(checkbox => {
        selectedPrestations.push(checkbox.value);
    });
    return selectedPrestations;
}

function loadResponsablesCA() {
    const agenceId = document.getElementById('agence').value;
    const prestationsSelectionnees = getSelectedPrestations();
    const responsableSelect = document.getElementById('responsable_ca');
    const responsableHelp = document.getElementById('responsable-help');

    if (!responsableSelect) return;

    responsableSelect.innerHTML = '<option value="">Chargement...</option>';
    responsableSelect.disabled = true;

    if (!agenceId || prestationsSelectionnees.length === 0) {
        responsableSelect.innerHTML = '<option value="">S√©lectionnez d\'abord une agence et des prestations</option>';
        if (responsableHelp) {
            responsableHelp.textContent = 'S√©lectionnez d\'abord une agence et au moins une prestation';
        }
        return;
    }

    // Construire l'URL avec les param√®tres GET
    const params = new URLSearchParams({
        agence_id: agenceId,
        prestation_ids: prestationsSelectionnees.join(',')
    });

    fetch(`/agences/api/get-responsables-ca/?${params}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }

        const responsables = data.responsables;

        if (responsables.length === 0) {
            responsableSelect.innerHTML = '<option value="">Aucun responsable CA trouv√©</option>';
            if (responsableHelp) {
                responsableHelp.textContent = 'Aucun responsable CA avec les prestations s√©lectionn√©es dans cette agence';
            }
            return;
        }

        responsableSelect.innerHTML = '<option value="">S√©lectionnez un responsable CA</option>';
        responsables.forEach(responsable => {
            const option = document.createElement('option');
            option.value = responsable.id;
            const prestationsNoms = responsable.types_prestation.map(p => p.nom).join(', ');
            option.textContent = `${responsable.prenoms} ${responsable.nom} - ${responsable.pseudo} (${prestationsNoms})`;
            responsableSelect.appendChild(option);
        });

        responsableSelect.disabled = false;
        if (responsableHelp) {
            responsableHelp.textContent = `${responsables.length} responsable(s) CA trouv√©(s)`;
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        responsableSelect.innerHTML = '<option value="">Erreur de chargement</option>';
        if (responsableHelp) {
            responsableHelp.textContent = 'Erreur lors du chargement des responsables';
        }
    });
}

function validateDates() {
    const dateDebut = document.getElementById('date_debut');
    const dateFin = document.getElementById('date_fin');
    const submitBtn = document.getElementById('submit-btn');

    if (!dateDebut || !dateFin || !submitBtn) return;

    if (dateDebut.value && dateFin.value) {
        if (new Date(dateDebut.value) >= new Date(dateFin.value)) {
            submitBtn.disabled = true;
            showAlert('La date de fin doit √™tre post√©rieure √† la date de d√©but', 'danger');
        } else {
            submitBtn.disabled = false;
            hideAlert();
        }
    }
}

function showAlert(message, type) {
    hideAlert();
    const dateFinParent = document.getElementById('date_fin').parentNode;
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show mt-2`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    dateFinParent.appendChild(alert);
}

function hideAlert() {
    const existingAlert = document.querySelector('.alert');
    if (existingAlert) {
        existingAlert.remove();
    }
}

function launchAppelOffre() {
    const formData = {
        agence_id: document.getElementById('agence').value,
        prestations_ids: getSelectedPrestations(),
        responsable_ca_id: document.getElementById('responsable_ca').value,
        date_debut: document.getElementById('date_debut').value,
        date_fin: document.getElementById('date_fin').value,
        description: document.getElementById('description').value
    };

    // Validation
    if (!formData.agence_id || !formData.prestations_ids.length || !formData.responsable_ca_id) {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
    }

    if (new Date(formData.date_debut) >= new Date(formData.date_fin)) {
        alert('La date de fin doit √™tre post√©rieure √† la date de d√©but');
        return;
    }

    fetch('/agences/api/appels-offre/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Appel d\'offre cr√©√© avec succ√®s !');

            // Fermer le modal et r√©initialiser le formulaire
            const modal = bootstrap.Modal.getInstance(document.getElementById('appelOffreModal'));
            modal.hide();
            document.getElementById('appelOffreForm').reset();

            // Recharger les donn√©es
            loadAppelsOffre();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la cr√©ation de l\'appel d\'offre');
    });
}

// === G√âN√âRATION DES VUES ===

function getAppelsFiltres() {
    if (!filtersApplied) {
        return appelsOffre;
    }

    const etatsSelectionnes = getCheckedValues('#filter-etat .filter-checkbox');
    const agencesSelectionnees = getCheckedValues('#filter-agence .filter-checkbox');
    const caSelectionnes = getCheckedValues('#filter-ca .filter-checkbox');
    const prestationsSelectionnees = getCheckedValues('#filter-prestation .filter-checkbox');
    const aoSelectionnes = getCheckedValues('#filter-ao .filter-checkbox');

    return appelsOffre.filter(appel => {
        // Filtre par √©tat
        if (etatsSelectionnes.length > 0 && !etatsSelectionnes.includes(appel.statut)) {
            return false;
        }

        // Filtre par agence
        if (agencesSelectionnees.length > 0 && !agencesSelectionnees.includes(appel.agence)) {
            return false;
        }

        // Filtre par CA
        if (caSelectionnes.length > 0 && !caSelectionnes.includes(appel.responsable)) {
            return false;
        }

        // Filtre par prestations
        if (prestationsSelectionnees.length > 0) {
            const hasMatchingPrestation = appel.prestations.some(prestation =>
                prestationsSelectionnees.includes(prestation)
            );
            if (!hasMatchingPrestation) return false;
        }

        // Filtre par AO
        if (aoSelectionnes.length > 0 && !aoSelectionnes.includes(appel.reference)) {
            return false;
        }

        return true;
    });
}

function getCheckedValues(selector) {
    const checked = [];
    document.querySelectorAll(selector).forEach(checkbox => {
        if (checkbox.checked) {
            checked.push(checkbox.value);
        }
    });
    return checked;
}

function generateGanttView() {
    const timelineHeader = document.getElementById('gantt-timeline-header');
    const ganttGrid = document.getElementById('gantt-grid');

    if (!timelineHeader || !ganttGrid) return;

    timelineHeader.innerHTML = '';
    ganttGrid.innerHTML = '';

    let appelsFiltres = getAppelsFiltres();
    appelsFiltres.sort((a, b) => new Date(a.date_debut) - new Date(b.date_debut));

    if (appelsFiltres.length === 0) {
        return;
    }

    // P√©riode fixe : ann√©e compl√®te
    let minDate = new Date(currentYear, 0, 1);
    let maxDate = new Date(currentYear, 11, 31);
    const msPerDay = 1000 * 60 * 60 * 24;
    const totalDays = Math.floor((maxDate - minDate) / msPerDay) + 1;
    const daysToShow = totalDays;
    const dayWidth = 80;

    // G√©n√©rer l'en-t√™te de timeline (jours de l'ann√©e)
    for (let i = 0; i < daysToShow; i++) {
        const date = new Date(minDate);
        date.setDate(minDate.getDate() + i);
        const period = document.createElement('div');
        period.className = 'gantt-period';
        period.style.width = `${dayWidth}px`;
        period.style.minWidth = `${dayWidth}px`;
        period.textContent = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        period.title = date.toLocaleDateString('fr-FR');
        timelineHeader.appendChild(period);
    }

    // Ajouter la barre du jour actuel si dans l'ann√©e
    const today = new Date();
    if (today.getFullYear() === currentYear) {
        const todayOffset = Math.floor((today - minDate) / msPerDay);
        if (todayOffset >= 0 && todayOffset < daysToShow) {
            const todayLine = document.createElement('div');
            todayLine.className = 'current-day-line';
            todayLine.style.left = `${todayOffset * dayWidth}px`;
            ganttGrid.appendChild(todayLine);
        }
    }

    // G√©n√©rer les barres seulement
    appelsFiltres.forEach((appel, index) => {
        const startDate = new Date(appel.date_debut);
        let endDate = new Date(appel.date_fin_reelle || appel.date_fin);
        const visibleStart = new Date(Math.max(startDate, minDate));
        const visibleEnd = new Date(Math.min(endDate, maxDate));

        if (visibleStart <= visibleEnd) {
            const vStartOffset = Math.floor((visibleStart - minDate) / msPerDay);
            const vDuration = Math.floor((visibleEnd - visibleStart) / msPerDay) + 1;

            const bar = document.createElement('div');
            const color = getColorForAppel(appel);
            bar.className = `gantt-bar ${appel.statut === 'Gagn√©' ? 'gagne' : ''} ${appel.statut === 'Perdu' ? 'perdu' : ''}`;
            bar.style.background = color;
            bar.style.left = `${vStartOffset * dayWidth}px`;
            bar.style.width = `${Math.max(5, vDuration * dayWidth)}px`;
            bar.style.top = `${index * 40 + 5}px`;
            bar.textContent = `${appel.reference}`;
            bar.title = `${appel.reference}: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()} (${appel.statut})`;
            bar.onclick = () => showAppelOffreDetails(appel.id);
            ganttGrid.appendChild(bar);
        }
    });

    // Restaurer la position de scroll apr√®s g√©n√©ration
    setTimeout(() => {
        const timeline = document.querySelector('.gantt-timeline');
        if (timeline) {
            const savedScroll = localStorage.getItem('ganttScrollLeft');
            if (savedScroll) {
                timeline.scrollLeft = parseFloat(savedScroll);
            }
        }
    }, 0);
}

function generateKanbanView() {
    const kanbanBoard = document.getElementById('kanban-board');
    if (!kanbanBoard) return;

    kanbanBoard.innerHTML = '';

    const columns = {
        'en-attente': { title: 'En Attente', status: 'En attente' },
        'en-cours': { title: 'En Cours', status: 'En cours' },
        'gagne': { title: 'Gagn√©', status: 'Gagn√©' },
        'perdu': { title: 'Perdu', status: 'Perdu' }
    };

    const appelsFiltres = getAppelsFiltres();

    Object.entries(columns).forEach(([key, column]) => {
        const columnDiv = document.createElement('div');
        columnDiv.className = 'kanban-column';

        const filteredAppels = appelsFiltres.filter(ao => ao.statut === column.status);
        const count = filteredAppels.length;

        columnDiv.innerHTML = `
            <div class="kanban-column-header">
                ${column.title} <span class="badge bg-secondary">${count}</span>
            </div>
            <div class="kanban-cards" id="kanban-${key}"></div>
        `;
        kanbanBoard.appendChild(columnDiv);

        const cardsContainer = document.getElementById(`kanban-${key}`);

        filteredAppels.forEach(appel => {
            const color = getColorForAppel(appel);
            const card = document.createElement('div');
            card.className = `kanban-card ${appel.statut === 'Gagn√©' ? 'gagne' : ''} ${appel.statut === 'Perdu' ? 'perdu' : ''}`;
            card.style.borderLeftColor = color;
            card.innerHTML = `
                <h6>${appel.reference}</h6>
                <p class="mb-1"><small><i class="fas fa-building me-1"></i>${appel.agence}</small></p>
                <p class="mb-1"><small><i class="fas fa-tasks me-1"></i>${appel.prestations.join(', ')}</small></p>
                <p class="mb-2"><small><i class="fas fa-user me-1"></i>${appel.responsable}</small></p>
                <p class="mb-2"><small><i class="fas fa-calendar me-1"></i>${formatDate(appel.date_debut)} ‚Üí ${formatDate(appel.date_fin_reelle || appel.date_fin)}</small></p>
                <div class="d-flex justify-content-between">
                    <button class="btn btn-sm btn-outline-primary" onclick="showAppelOffreDetails(${appel.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${generateActionButtons(appel)}
                </div>
            `;
            cardsContainer.appendChild(card);
        });
    });
}

function generateTimelineView() {
    const timelineEvents = document.getElementById('timeline-events');
    const timelineHeader = document.getElementById('timeline-header');
    const currentTime = document.getElementById('timeline-current-time');

    if (!timelineEvents || !timelineHeader || !currentTime) return;

    timelineEvents.innerHTML = '';
    timelineHeader.innerHTML = '';

    currentTime.textContent = new Date().toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    const appelsFiltres = getAppelsFiltres();

    if (appelsFiltres.length === 0) {
        timelineEvents.innerHTML = '<div class="text-center text-muted mt-5">Aucun appel d\'offre trouv√©</div>';
        return;
    }

    // P√©riode fixe : ann√©e compl√®te
    let minDate = new Date(currentTimelineYear, 0, 1);
    let maxDate = new Date(currentTimelineYear, 11, 31);
    const msPerDay = 1000 * 60 * 60 * 24;
    const totalDays = Math.floor((maxDate - minDate) / msPerDay) + 1;
    const daysToShow = totalDays;
    const dayWidth = 100;

    // En-t√™te de timeline
    for (let i = 0; i < daysToShow; i++) {
        const date = new Date(minDate);
        date.setDate(minDate.getDate() + i);
        const period = document.createElement('div');
        period.className = 'timeline-period';
        period.style.width = `${dayWidth}px`;
        period.style.minWidth = `${dayWidth}px`;
        period.textContent = `${date.getDate()}/${date.getMonth() + 1}`;
        period.title = date.toLocaleDateString('fr-FR');
        timelineHeader.appendChild(period);
    }

    // Conteneur pour les √©v√©nements
    const timelineContent = document.createElement('div');
    timelineContent.className = 'timeline-content';
    timelineContent.style.width = `${daysToShow * dayWidth}px`;
    timelineContent.style.position = 'relative';
    timelineContent.style.height = '100%';

    // Ajouter la barre du jour actuel
    const today = new Date();
    if (today.getFullYear() === currentTimelineYear) {
        const todayOffset = Math.floor((today - minDate) / msPerDay);
        if (todayOffset >= 0 && todayOffset < daysToShow) {
            const todayLine = document.createElement('div');
            todayLine.className = 'current-day-line';
            todayLine.style.left = `${todayOffset * dayWidth}px`;
            todayLine.style.height = '100%';
            timelineContent.appendChild(todayLine);
        }
    }

    // √âv√©nements
    appelsFiltres.forEach((appel, index) => {
        const startDate = new Date(appel.date_debut);
        let endDate = new Date(appel.date_fin_reelle || appel.date_fin);
        const visibleStart = new Date(Math.max(startDate, minDate));
        const visibleEnd = new Date(Math.min(endDate, maxDate));

        if (visibleStart <= visibleEnd) {
            const vStartOffset = Math.floor((visibleStart - minDate) / msPerDay);
            const vDuration = Math.floor((visibleEnd - visibleStart) / msPerDay) + 1;

            const event = document.createElement('div');
            const color = getColorForAppel(appel);
            event.className = `timeline-event ${appel.statut === 'Gagn√©' ? 'gagne' : ''} ${appel.statut === 'Perdu' ? 'perdu' : ''}`;
            event.style.background = color;
            event.style.borderLeftColor = color;
            event.style.left = `${vStartOffset * dayWidth}px`;
            event.style.width = `${vDuration * dayWidth}px`;
            event.style.top = `${(index % 4) * 100 + 20}px`;
            event.style.position = 'absolute';
            event.innerHTML = `
                <div class="timeline-event-content" style="color: ${appel.statut === 'Gagn√©' || appel.statut === 'Perdu' ? 'white' : 'black'}">
                    <strong>${appel.reference}</strong><br>
                    <small>${appel.agence}</small>
                </div>
            `;
            event.onclick = () => showAppelOffreDetails(appel.id);
            timelineContent.appendChild(event);
        }
    });

    timelineEvents.appendChild(timelineContent);

    // Restaurer la position de scroll apr√®s g√©n√©ration
    setTimeout(() => {
        const timelineEventsEl = document.querySelector('.timeline-events');
        if (timelineEventsEl) {
            const savedScroll = localStorage.getItem('timelineScrollLeft');
            if (savedScroll) {
                timelineEventsEl.scrollLeft = parseFloat(savedScroll);
            }
        }
    }, 0);
}

function generateCalendarView() {
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonth = document.getElementById('calendar-current-month');

    if (!calendarGrid || !currentMonth) return;

    calendarGrid.innerHTML = '';

    const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                      'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

    currentMonth.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;

    const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
    const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
    const today = new Date();
    const appelsFiltres = getAppelsFiltres();

    const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

    // Jours du mois pr√©c√©dent
    const prevMonthLastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 0).getDate();
    for (let i = startDay - 1; i >= 0; i--) {
        const day = document.createElement('div');
        day.className = 'calendar-day other-month';
        const dayNumber = prevMonthLastDay - i;
        const prevMonthDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() - 1, dayNumber);
        day.innerHTML = `<div class="calendar-day-number">${dayNumber}</div>`;

        if (prevMonthDate.getDay() === 0 || prevMonthDate.getDay() === 6) {
            day.classList.add('weekend');
        }

        addEventsToCalendarDay(day, prevMonthDate, appelsFiltres);
        calendarGrid.appendChild(day);
    }

    // Jours du mois courant
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayElement = document.createElement('div');
        const currentDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
        const isToday = currentDate.toDateString() === today.toDateString();
        const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;

        dayElement.className = `calendar-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}`;
        dayElement.innerHTML = `<div class="calendar-day-number">${day}</div>`;

        addEventsToCalendarDay(dayElement, currentDate, appelsFiltres);
        calendarGrid.appendChild(dayElement);
    }

    // Jours du mois suivant
    const totalCells = 42;
    const remainingCells = totalCells - (startDay + lastDay.getDate());
    for (let i = 1; i <= remainingCells; i++) {
        const day = document.createElement('div');
        day.className = 'calendar-day other-month';
        const nextMonthDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, i);
        day.innerHTML = `<div class="calendar-day-number">${i}</div>`;

        if (nextMonthDate.getDay() === 0 || nextMonthDate.getDay() === 6) {
            day.classList.add('weekend');
        }

        addEventsToCalendarDay(day, nextMonthDate, appelsFiltres);
        calendarGrid.appendChild(day);
    }
}

function addEventsToCalendarDay(dayElement, currentDate, appelsFiltres) {
    // Normaliser les dates √† minuit pour comparaison pr√©cise
    const currDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());

    const eventsToday = appelsFiltres.filter(appel => {
        try {
            const startDate = new Date(appel.date_debut);
            const endDate = new Date(appel.date_fin_reelle || appel.date_fin);
            const startDay = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const endDay = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

            if (isNaN(startDay.getTime()) || isNaN(endDay.getTime())) {
                return false;
            }

            // Inclure explicitement la date de d√©but et de fin
            return currDay >= startDay && currDay <= endDay;
        } catch (error) {
            console.error('Erreur avec AO:', appel.reference, error);
            return false;
        }
    });

    eventsToday.forEach(event => {
        const eventElement = document.createElement('div');
        const color = getColorForAppel(event);
        eventElement.className = `calendar-event ${event.statut === 'Gagn√©' ? 'gagne' : ''} ${event.statut === 'Perdu' ? 'perdu' : ''}`;
        eventElement.style.background = color;

        const isStartDay = new Date(event.date_debut).toDateString() === currentDate.toDateString();
        const isEndDay = new Date(event.date_fin_reelle || event.date_fin).toDateString() === currentDate.toDateString();

        let opacity = '0.7';
        if (isStartDay || isEndDay) {
            opacity = '1';
            if (isStartDay) eventElement.style.borderLeft = '3px solid #000';
            if (isEndDay) eventElement.style.borderRight = '3px solid #000';
        }

        eventElement.style.opacity = opacity;
        eventElement.textContent = event.reference;
        eventElement.title = `${event.reference}\n${event.prestations.join(', ')} - ${event.agence}\n${event.statut}\n${new Date(event.date_debut).toLocaleDateString()} ‚Üí ${new Date(event.date_fin_reelle || event.date_fin).toLocaleDateString()}`;
        eventElement.onclick = () => showAppelOffreDetails(event.id);
        dayElement.appendChild(eventElement);
    });
}

// === GESTION DES FILTRES ===

// Sauvegarder les filtres
function saveFilters() {
    const filters = {};
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
        filters[checkbox.id] = checkbox.checked;
    });
    localStorage.setItem('commercialFilters', JSON.stringify(filters));
    localStorage.setItem('filtersApplied', filtersApplied.toString());
}

// Restaurer les filtres
function loadFilters() {
    const savedFilters = localStorage.getItem('commercialFilters');
    const savedApplied = localStorage.getItem('filtersApplied');

    if (savedFilters) {
        const filters = JSON.parse(savedFilters);
        Object.keys(filters).forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.checked = filters[id];
            }
        });
    }

    if (savedApplied) {
        filtersApplied = (savedApplied === 'true');
    }
}

function applyFilters() {
    filtersApplied = true;
    saveFilters();
    updateAllViews();
    showSuccessMessage('Filtres appliqu√©s avec succ√®s');
}

function resetFilters() {
    filtersApplied = false;
    document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    saveFilters();
    updateAllViews();
    showSuccessMessage('Filtres r√©initialis√©s');
}

// === FONCTIONS UTILITAIRES ===

function generateActionButtons(appel) {
    let buttons = '';

    if (appel.statut === 'En cours') {
        buttons += `
            <button class="btn btn-sm btn-success" onclick="preparerGagne(${appel.id})">
                <i class="fas fa-trophy"></i>
            </button>
        `;
    }

    if (appel.statut !== 'Gagn√©' && appel.statut !== 'Perdu') {
        buttons += `
            <button class="btn btn-sm btn-danger" onclick="preparerPerdu(${appel.id})">
                <i class="fas fa-times"></i>
            </button>
        `;
    }

    return buttons;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR');
}

function updateAllViews() {
    generateGanttView();
    generateKanbanView();
    generateTimelineView();
    generateCalendarView();
}

function updateFilterCA() {
    const filterCA = document.getElementById('filter-ca');
    const responsables = [...new Set(appelsOffre.map(ao => ao.responsable))];

    filterCA.innerHTML = '';
    responsables.forEach(responsable => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input filter-checkbox" type="checkbox" value="${responsable}" id="filter-ca-${responsable}" checked>
            <label class="form-check-label" for="filter-ca-${responsable}">
                ${responsable}
            </label>
        `;
        filterCA.appendChild(div);
    });
}

function updateFilterAO() {
    const filterAO = document.getElementById('filter-ao');
    const references = [...new Set(appelsOffre.map(ao => ao.reference))];

    filterAO.innerHTML = '';
    references.forEach(reference => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input filter-checkbox" type="checkbox" value="${reference}" id="filter-ao-${reference}" checked>
            <label class="form-check-label" for="filter-ao-${reference}">
                ${reference}
            </label>
        `;
        filterAO.appendChild(div);
    });
}

function showTodayCalendar() {
    currentCalendarDate = new Date();
    generateCalendarView();
}

function prevMonthCalendar() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    generateCalendarView();
}

function nextMonthCalendar() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    generateCalendarView();
}

function showAlertesRetard(appelsEnRetard) {
    const container = document.getElementById('alertes-container');
    container.innerHTML = '';

    appelsEnRetard.forEach(appel => {
        const alerte = document.createElement('div');
        alerte.className = 'alerte-retard';
        alerte.innerHTML = `
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Appel d'offre en retard</h6>
            <p class="mb-1"><strong>${appel.reference}</strong> - ${appel.agence}</p>
            <p class="mb-0">Date de fin d√©pass√©e depuis ${appel.jours_retard} jour(s)</p>
        `;
        container.appendChild(alerte);
    });
}

function getColorForStatut(statut) {
    switch(statut) {
        case 'Gagn√©':
            return '#28a745';
        case 'Perdu':
            return '#dc3545';
        default:
            return null;
    }
}

function showSuccessMessage(message) {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    toastContainer.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

function showError(message) {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-danger border-0';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    toastContainer.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

// === FONCTIONS GLOBALES ===

function toggleAllCheckboxes(filterType, checked) {
    const checkboxes = document.querySelectorAll(`#filter-${filterType} .filter-checkbox`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = checked;
    });
}

function invertCheckboxes(filterType) {
    const checkboxes = document.querySelectorAll(`#filter-${filterType} .filter-checkbox`);
    checkboxes.forEach(checkbox => {
        checkbox.checked = !checkbox.checked;
    });
}

function showAppelOffreDetails(id) {
    const appel = appelsOffre.find(ao => ao.id === id);
    if (appel) {
        const modalHtml = `
            <div class="modal fade" id="detailModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">D√©tails de ${appel.reference}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Agence:</strong> ${appel.agence}</p>
                                    <p><strong>Prestations:</strong> ${appel.prestations.join(', ')}</p>
                                    <p><strong>Responsable CA:</strong> ${appel.responsable}</p>
                                    <p><strong>Date d√©but:</strong> ${new Date(appel.date_debut).toLocaleDateString('fr-FR')}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Date fin pr√©vue:</strong> ${new Date(appel.date_fin).toLocaleDateString('fr-FR')}</p>
                                    ${appel.date_fin_reelle ? `<p><strong>Date fin r√©elle:</strong> ${new Date(appel.date_fin_reelle).toLocaleDateString('fr-FR')}</p>` : ''}
                                    <p><strong>Statut:</strong> <span class="badge bg-${getStatusColor(appel.statut)}">${appel.statut}</span></p>
                                    ${appel.commentaire_arret ? `<p><strong>Commentaire:</strong><br>${appel.commentaire_arret}</p>` : ''}
                                </div>
                            </div>
                            ${appel.description ? `<hr><p><strong>Description:</strong><br>${appel.description}</p>` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        const modal = new bootstrap.Modal(document.getElementById('detailModal'));
        modal.show();

        document.getElementById('detailModal').addEventListener('hidden.bs.modal', function() {
            modalContainer.remove();
        });
    }
}

function getStatusColor(statut) {
    const colors = {
        'En attente': 'warning',
        'En cours': 'primary',
        'Gagn√©': 'success',
        'Perdu': 'danger'
    };
    return colors[statut] || 'secondary';
}

function preparerGagne(id) {
    currentAppelId = id;
    const modal = new bootstrap.Modal(document.getElementById('gagneModal'));
    modal.show();
}

function confirmerGagne() {
    if (!currentAppelId) return;

    const commentaire = document.getElementById('commentaire_gagne').value;

    fetch(`/agences/api/appels-offre/${currentAppelId}/statut/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            statut: 'gagne',
            commentaire: commentaire
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Appel d\'offre marqu√© comme gagn√© !');
            const modal = bootstrap.Modal.getInstance(document.getElementById('gagneModal'));
            modal.hide();
            loadAppelsOffre();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la mise √† jour du statut');
    });
}

function preparerPerdu(id) {
    currentAppelId = id;
    const modal = new bootstrap.Modal(document.getElementById('perduModal'));
    modal.show();
}

function confirmerPerdu() {
    if (!currentAppelId) return;

    const commentaire = document.getElementById('commentaire_perdu').value;

    fetch(`/agences/api/appels-offre/${currentAppelId}/statut/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            statut: 'perdu',
            commentaire: commentaire
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Appel d\'offre marqu√© comme perdu !');
            const modal = bootstrap.Modal.getInstance(document.getElementById('perduModal'));
            modal.hide();
            loadAppelsOffre();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la mise √† jour du statut');
    });
}
</script>

{% endblock %}